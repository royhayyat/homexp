<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×× ×”×œ ×”×•×¦××•×ª ××©×¤×—×ª×™ â˜ï¸</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <style>
        :root {
            --primary-color: #4f46e5;
            --secondary-color: #818cf8;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --info-color: #3b82f6;
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-color: #1f2937;
            --border-color: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        [data-theme="dark"] {
            --bg-color: #111827;
            --card-bg: #1f2937;
            --text-color: #f9fafb;
            --border-color: #374151;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-color); direction: rtl; text-align: right; padding-bottom: 40px; transition: background 0.3s; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        
        /* Header */
        header { margin-bottom: 20px; }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        h1 { font-size: 1.5rem; color: var(--primary-color); display: flex; align-items: center; gap: 10px; margin: 0; }
        
        .last-update-bar {
            background-color: var(--card-bg);
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 0.85rem;
            color: #6b7280;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
        }
        .user-indicator { font-weight: bold; color: var(--primary-color); }

        /* Modals (Login / Profile) */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000;
        }
        .modal {
            background: var(--card-bg); padding: 30px; border-radius: 16px;
            width: 90%; max-width: 400px; text-align: center;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }
        .modal h2 { color: var(--primary-color); margin-bottom: 20px; }
        .modal input { width: 100%; margin-bottom: 15px; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; background: var(--bg-color); color: var(--text-color); }
        .modal button { width: 100%; padding: 12px; font-size: 1rem; border-radius: 8px; cursor: pointer; border: none; font-weight: bold; transition: 0.2s; }
        
        /* Tabs */
        .auth-tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); }
        .auth-tab { flex: 1; padding: 10px; cursor: pointer; color: var(--text-color); opacity: 0.6; }
        .auth-tab.active { border-bottom: 2px solid var(--primary-color); opacity: 1; font-weight: bold; color: var(--primary-color); }

        .profile-btn {
            background: var(--bg-color); border: 1px solid var(--border-color); padding: 12px;
            margin: 8px 0; width: 100%; border-radius: 8px; cursor: pointer;
            font-size: 1rem; color: var(--text-color); transition: 0.2s; display: flex; justify-content: space-between;
        }
        .profile-btn:hover { border-color: var(--primary-color); background: rgba(79, 70, 229, 0.05); }

        /* General UI */
        .status-dot { height: 10px; width: 10px; background-color: #ccc; border-radius: 50%; display: inline-block; }
        .status-online { background-color: var(--success-color); box-shadow: 0 0 8px var(--success-color); }

        .card { background-color: var(--card-bg); border-radius: 12px; padding: 20px; box-shadow: var(--shadow); margin-bottom: 20px; border: 1px solid var(--border-color); }
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 600px) { .dashboard { grid-template-columns: 1fr; } }
        
        .total-amount { font-size: 2rem; font-weight: bold; color: var(--success-color); margin-top: 10px; text-align: center; }
        .chart-container { height: 200px; display: flex; justify-content: center; align-items: center; }

        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; align-items: end; }
        input, select { padding: 10px; width: 100%; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-color); font-size: 1rem; }
        
        .extra-fields { background-color: rgba(59, 130, 246, 0.05); padding: 15px; border-radius: 8px; margin-top: 10px; display: none; grid-column: 1 / -1; border: 1px dashed var(--info-color); }
        .calc-preview { font-size: 0.9rem; color: var(--primary-color); font-weight: bold; margin-top: 5px; }

        button.add-btn { background-color: var(--primary-color); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; width: 100%; font-weight: bold; margin-top: 15px; font-size: 1rem; transition: transform 0.1s;}
        button.add-btn:active { transform: scale(0.98); }
        button.add-btn:hover { opacity: 0.9; }

        .filters { display: flex; gap: 10px; margin-bottom: 15px; overflow-x: auto; }
        .expense-list { width: 100%; border-collapse: collapse; }
        .expense-list td { padding: 12px; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        
        .badge { font-size: 0.7em; padding: 2px 6px; border-radius: 4px; background: #eee; color: #555; margin-right: 5px; vertical-align: middle;}
        .badge-loan { background: #fee2e2; color: #991b1b; }
        .badge-installments { background: #dbeafe; color: #1e40af; }
        
        .delete-btn { background-color: transparent; color: var(--text-color); border: 1px solid var(--border-color); padding: 6px 12px; border-radius: 6px; cursor: pointer; opacity: 0.7; }
        .delete-btn:hover { background-color: #fee2e2; color: var(--danger-color); border-color: var(--danger-color); opacity: 1; }

        #syncBtn { display: none; background: var(--primary-color); color: white; border: none; padding: 15px; width: 100%; border-radius: 8px; margin-bottom: 20px; cursor: pointer; font-weight: bold; }
        .loader { text-align: center; padding: 20px; display: none; opacity: 0.7; }
        
        .auth-error { color: var(--danger-color); margin-top: 10px; font-size: 0.9rem; display: none; background: rgba(239, 68, 68, 0.1); padding: 8px; border-radius: 4px;}
    </style>
</head>
<body>

<div id="authOverlay" class="overlay">
    <div class="modal">
        <h2>ğŸ  ×›× ×™×¡×” ×œ×‘×™×ª</h2>
        
        <div class="auth-tabs">
            <div class="auth-tab active" onclick="switchAuthTab('login')" id="tabLogin">×”×ª×—×‘×¨×•×ª</div>
            <div class="auth-tab" onclick="switchAuthTab('register')" id="tabRegister">×™×¦×™×¨×ª ×‘×™×ª ×—×“×©</div>
        </div>

        <form onsubmit="handleAuth(event)">
            <input type="email" id="authEmail" placeholder="××™××™×™×œ (×©× ×”××©×ª××© ×œ×—×©×‘×•×Ÿ ×”×‘×™×ª)" required dir="ltr">
            <input type="password" id="authPass" placeholder="×¡×™×¡××” (×œ×¤×—×•×ª 6 ×ª×•×•×™×)" required dir="ltr" minlength="6">
            <button type="submit" class="add-btn" id="authSubmitBtn">×”×›× ×¡ ×œ×‘×™×ª</button>
            <div id="authError" class="auth-error"></div>
        </form>
    </div>
</div>

<div id="profileOverlay" class="overlay" style="display:none">
    <div class="modal">
        <h2>ğŸ‘‹ ××™ ×–×”?</h2>
        <p style="margin-bottom:15px; font-size:0.9rem; opacity:0.8">×‘×—×¨ ××ª ×”×¤×¨×•×¤×™×œ ×©×œ×š ×‘×‘×™×ª ×”×–×”</p>
        <div id="profilesList" style="margin-bottom:20px; max-height: 200px; overflow-y: auto;"></div>
        
        <div style="border-top:1px solid var(--border-color); padding-top:15px">
            <input type="text" id="newProfileName" placeholder="××• ×”×§×œ×“ ×©× ×—×“×©..." style="margin-bottom:10px">
            <button onclick="selectProfile(document.getElementById('newProfileName').value)" class="add-btn" style="background-color: var(--success-color)">×¦×•×¨ ×¤×¨×•×¤×™×œ ×•×›× ×¡</button>
        </div>
        <button onclick="logout()" style="background:none; border:none; color:var(--danger-color); margin-top:15px; cursor:pointer; font-size:0.9rem">×™×¦×™××” ××”×—×©×‘×•×Ÿ</button>
    </div>
</div>

<div class="container">
    <header>
        <div class="header-top">
            <h1>
                <span id="connectionStatus" class="status-dot" title="×¡×˜×˜×•×¡ ×—×™×‘×•×¨"></span>
                ×”×•×¦××•×ª ×”×‘×™×ª
            </h1>
            <div>
                <span id="currentUserDisplay" style="margin-left:10px; font-weight:bold; color:var(--primary-color)"></span>
                <button onclick="toggleTheme()" style="background:none; border:1px solid var(--border-color); padding:5px 10px; border-radius:5px; cursor: pointer;">ğŸŒ“</button>
                <button onclick="logout()" style="background:none; border:1px solid var(--danger-color); color:var(--danger-color); padding:5px 10px; border-radius:5px; cursor: pointer; margin-right:5px">×™×¦×™××”</button>
            </div>
        </div>
        
        <div class="last-update-bar">
            <span>ğŸ“… ×¢×•×“×›×Ÿ: <span id="lastUpdateText">--</span></span>
            <span id="lastUpdateUser" class="user-indicator"></span>
        </div>
    </header>

    <button id="syncBtn" onclick="migrateLocalToCloud()">âš ï¸ × ××¦××• × ×ª×•× ×™× ×™×©× ×™× ×‘××›×©×™×¨ ×–×”! <br> ×œ×—×¥ ×›××Ÿ ×œ×”×¢×œ××” ×œ×—×©×‘×•×Ÿ ×”× ×•×›×—×™</button>
    <div id="loader" class="loader">×˜×•×¢×Ÿ × ×ª×•× ×™× ××”×¢× ×Ÿ...</div>

    <div class="dashboard card">
        <div style="text-align: center;">
            <h2>×¡×”"×› ×—×•×“×©×™</h2>
            <div class="total-amount" id="monthlyTotal">â‚ª0.00</div>
        </div>
        <div class="chart-container">
            <canvas id="expensesChart" width="200" height="200"></canvas>
        </div>
    </div>

    <div class="card">
        <h3>â• ×”×•×¡×¤×ª ×”×•×¦××”</h3>
        <form id="expenseForm" onsubmit="addExpense(event)">
            <div class="form-grid">
                <div style="grid-column: span 2;">
                    <label style="font-size:0.8rem">×¡×•×’</label>
                    <select id="expenseType" onchange="toggleExtraFields()" style="font-weight:bold">
                        <option value="regular">×¨×’×™×œ×”</option>
                        <option value="installments">ğŸ’³ ×ª×©×œ×•××™×</option>
                        <option value="loan">ğŸ¦ ×”×œ×•×•××”</option>
                    </select>
                </div>
                
                <div>
                    <label style="font-size:0.8rem">×§×˜×’×•×¨×™×”</label>
                    <select id="category">
                        <option value="××–×•×Ÿ">ğŸ• ××–×•×Ÿ</option>
                        <option value="×—×©××œ/××™×">ğŸ’¡ ×—×©××œ/××™×</option>
                        <option value="×ª×©×œ×•××™× ×§×‘×•×¢×™×">ğŸ¦ ×§×‘×•×¢×™×</option>
                        <option value="×ª×—×‘×•×¨×”">ğŸš— ×ª×—×‘×•×¨×”</option>
                        <option value="×‘×™×’×•×“">ğŸ‘• ×‘×™×’×•×“</option>
                        <option value="×‘×™×œ×•×™×™×">ğŸ‰ ×‘×™×œ×•×™×™×</option>
                        <option value="××—×¨">ğŸ“¦ ××—×¨</option>
                    </select>
                </div>

                <input type="text" id="desc" placeholder="×ª×™××•×¨ (×œ××©×œ: ×¡×•×¤×¨)" required>
                <input type="number" id="amount" placeholder="×¡×›×•×" step="0.01" required>
                <input type="date" id="date" required>
            </div>

            <div id="extraFields" class="extra-fields form-grid">
                <div id="installmentsContainer" style="display:none; width:100%; grid-column: 1 / -1;">
                    <div class="form-grid">
                        <div>
                            <label style="font-size:0.8rem">×¡×›×•× ××œ×</label>
                            <input type="number" id="totalPrice" placeholder="×¡×”×´×›" step="0.01" oninput="calculateInstallment()">
                        </div>
                        <div>
                            <label style="font-size:0.8rem">×ª×©×œ×•××™×</label>
                            <input type="number" id="numberOfPayments" placeholder="×›××•×ª" min="2" max="60" oninput="calculateInstallment()">
                        </div>
                    </div>
                    <div id="installmentResult" class="calc-preview"></div>
                </div>
                <div id="loanContainer" style="display:none; width:100%">
                    <label style="font-size:0.8rem">×™×ª×¨×ª ×—×•×“×©×™×</label>
                    <input type="number" id="monthsLeft" placeholder="×œ××©×œ: 12">
                </div>
            </div>

            <button type="submit" class="add-btn" id="submitBtn">×”×•×¡×£ ×”×•×¦××”</button>
        </form>
    </div>

    <div class="card">
        <div class="filters">
            <select id="filterCategory" onchange="renderExpenses()">
                <option value="all">×”×›×œ</option>
                <option value="××–×•×Ÿ">××–×•×Ÿ</option>
                <option value="×—×©××œ/××™×">×—×©××œ/××™×</option>
                <option value="×ª×©×œ×•××™× ×§×‘×•×¢×™×">×§×‘×•×¢×™×</option>
                <option value="×ª×—×‘×•×¨×”">×ª×—×‘×•×¨×”</option>
                <option value="×‘×™×’×•×“">×‘×™×’×•×“</option>
                <option value="×‘×™×œ×•×™×™×">×‘×™×œ×•×™×™×</option>
                <option value="××—×¨">××—×¨</option>
            </select>
            <input type="month" id="filterMonth" onchange="renderExpenses()">
        </div>
        <table class="expense-list">
            <tbody id="expensesTableBody"></tbody>
        </table>
    </div>
</div>

<script>
    // --- ×”×’×“×¨×•×ª FIREBASE ---
    // ×× × ×”×“×‘×§ ×›××Ÿ ××ª ×”××¤×ª×— ×”×××™×ª×™ ×©×œ×š ×‘××§×•× ×”×˜×§×¡×˜ ×œ××˜×”
    const firebaseConfig = {
      apiKey: "YOUR_REAL_API_KEY_HERE",
      authDomain: "homeexpenses-e2bb7.firebaseapp.com",
      databaseURL: "https://homeexpenses-e2bb7-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "homeexpenses-e2bb7",
      storageBucket: "homeexpenses-e2bb7.firebasestorage.app",
      messagingSenderId: "322915198222",
      appId: "1:322915198222:web:fcc826384329c9bfb9a35f"
    };

    let app, db, auth, expensesRef, metaRef, usersRef;
    let expenses = []; 
    let currentUserProfile = null;
    let isRegisterMode = false;

    // ××ª×—×•×œ ×”××¢×¨×›×ª
    try {
        app = firebase.initializeApp(firebaseConfig);
        db = firebase.database();
        auth = firebase.auth();
    } catch (e) { console.error("Firebase init error:", e); }

    // --- ×œ×•×’×™×§×ª ××©×ª××©×™× ×•×—×©×‘×•× ×•×ª ---

    // ××¢×‘×¨ ×‘×™×Ÿ ×œ×©×•× ×™×•×ª ×›× ×™×¡×”/×”×¨×©××”
    function switchAuthTab(mode) {
        isRegisterMode = mode === 'register';
        document.getElementById('tabLogin').className = isRegisterMode ? 'auth-tab' : 'auth-tab active';
        document.getElementById('tabRegister').className = isRegisterMode ? 'auth-tab active' : 'auth-tab';
        document.getElementById('authSubmitBtn').innerText = isRegisterMode ? '×¦×•×¨ ×‘×™×ª ×—×“×©' : '×”×›× ×¡ ×œ×‘×™×ª';
        document.getElementById('authError').style.display = 'none';
    }

    // ×˜×™×¤×•×œ ×‘×˜×•×¤×¡ Auth
    function handleAuth(e) {
        e.preventDefault();
        const email = document.getElementById('authEmail').value;
        const pass = document.getElementById('authPass').value;
        const errorDiv = document.getElementById('authError');
        errorDiv.style.display = 'none';

        if (isRegisterMode) {
            auth.createUserWithEmailAndPassword(email, pass)
                .catch(err => {
                    errorDiv.style.display = 'block';
                    errorDiv.innerText = getAuthErrorMessage(err.code);
                });
        } else {
            auth.signInWithEmailAndPassword(email, pass)
                .catch(err => {
                    errorDiv.style.display = 'block';
                    errorDiv.innerText = getAuthErrorMessage(err.code);
                });
        }
    }

    function getAuthErrorMessage(code) {
        switch(code) {
            case 'auth/email-already-in-use': return '×”××™×™×œ ×”×–×” ×›×‘×¨ ×§×™×™× ×‘××¢×¨×›×ª';
            case 'auth/invalid-email': return '×›×ª×•×‘×ª ××™×™×œ ×œ× ×ª×§×™× ×”';
            case 'auth/weak-password': return '×”×¡×™×¡××” ×—×œ×©×” ××“×™ (××™× ×™××•× 6 ×ª×•×•×™×)';
            case 'auth/user-not-found': return '××©×ª××© ×œ× × ××¦×, ××•×œ×™ ×¢×œ×™×š ×œ×”×™×¨×©×?';
            case 'auth/wrong-password': return '×¡×™×¡××” ×©×’×•×™×”';
            default: return '×©×’×™××”: ' + code;
        }
    }

    // ×”××–× ×” ×œ×©×™× ×•×™×™ ×¡×˜×˜×•×¡ (×›× ×™×¡×”/×™×¦×™××”)
    if(auth) {
        auth.onAuthStateChanged(user => {
            if (user) {
                // ××©×ª××© ××—×•×‘×¨!
                document.getElementById('authOverlay').style.display = 'none';
                
                // ×”×’×“×¨×ª × ×ª×™×‘×™× ×‘-DB ×œ×¤×™ ×”-UID ×”×™×™×—×•×“×™ ×©×œ ×”×—×©×‘×•×Ÿ
                const householdPath = `households/${user.uid}`;
                expensesRef = db.ref(`${householdPath}/expenses`);
                usersRef = db.ref(`${householdPath}/users`);
                metaRef = db.ref(`${householdPath}/meta/lastUpdate`);

                // ×‘×“×™×§×ª ×¤×¨×•×¤×™×œ ×¤× ×™××™
                const savedProfile = localStorage.getItem(`profile_${user.uid}`);
                if (savedProfile) {
                    currentUserProfile = savedProfile;
                    document.getElementById('currentUserDisplay').innerText = `×©×œ×•×, ${currentUserProfile}`;
                    listenToData();
                } else {
                    document.getElementById('profileOverlay').style.display = 'flex';
                    loadUsersList();
                }
            } else {
                // ×× ×•×ª×§
                document.getElementById('authOverlay').style.display = 'flex';
                document.getElementById('profileOverlay').style.display = 'none';
                expenses = [];
                renderExpenses();
            }
        });
    }

    function logout() {
        auth.signOut().then(() => {
            currentUserProfile = null;
            location.reload(); 
        });
    }

    // --- × ×™×”×•×œ ×¤×¨×•×¤×™×œ×™× ---
    function loadUsersList() {
        usersRef.once('value', snap => {
            const listDiv = document.getElementById('profilesList');
            listDiv.innerHTML = '';
            const users = snap.val();
            
            if (users) {
                Object.keys(users).forEach(name => {
                    const btn = document.createElement('div');
                    btn.className = 'profile-btn';
                    btn.innerHTML = `<span>ğŸ‘¤ ${name}</span> <span>âœ</span>`;
                    btn.onclick = () => selectProfile(name);
                    listDiv.appendChild(btn);
                });
            } else {
                listDiv.innerHTML = '<p style="font-size:0.8rem; color:#888">×–×”×• ×‘×™×ª ×—×“×©! ×¦×•×¨ ××ª ×”×¤×¨×•×¤×™×œ ×”×¨××©×•×Ÿ.</p>';
            }
        });
    }

    function selectProfile(name) {
        if (!name || name.trim() === '') return;
        name = name.trim();
        currentUserProfile = name;
        localStorage.setItem(`profile_${auth.currentUser.uid}`, name);
        usersRef.child(name).set(true);
        document.getElementById('profileOverlay').style.display = 'none';
        document.getElementById('currentUserDisplay').innerText = `×©×œ×•×, ${name}`;
        listenToData();
    }

    // --- ×œ×•×’×™×§×ª × ×ª×•× ×™× ---
    
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('date').valueAsDate = new Date();
        const today = new Date();
        document.getElementById('filterMonth').value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
        
        if(localStorage.getItem('theme') === 'dark') document.body.setAttribute('data-theme', 'dark');
    });

    function listenToData() {
        document.getElementById('loader').style.display = 'block';
        
        db.ref('.info/connected').on('value', snap => {
            const dot = document.getElementById('connectionStatus');
            dot.className = snap.val() ? 'status-dot status-online' : 'status-dot';
        });

        metaRef.on('value', snap => {
            const data = snap.val();
            if (data) {
                document.getElementById('lastUpdateText').innerText = data.time;
                document.getElementById('lastUpdateUser').innerText = `(${data.user})`;
            }
        });

        expensesRef.on('value', snapshot => {
            document.getElementById('loader').style.display = 'none';
            const data = snapshot.val();
            expenses = [];
            if (data) {
                Object.keys(data).forEach(key => expenses.push({ ...data[key], firebaseId: key }));
            }
            renderExpenses();
            
            // ×‘×“×™×§×” ×× ×™×© × ×ª×•× ×™× ×™×©× ×™× ×œ××™×’×¨×¦×™×”
            const localData = localStorage.getItem('home_expenses_v1');
            if (localData && JSON.parse(localData).length > 0) {
                 document.getElementById('syncBtn').style.display = 'block';
            }
        });
    }

    function updateLastAction() {
        const now = new Date();
        const timeString = `${now.getDate()}/${now.getMonth()+1} ${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}`;
        metaRef.set({
            user: currentUserProfile,
            time: timeString
        });
    }

    function addExpense(e) {
        e.preventDefault();
        const type = document.getElementById('expenseType').value;
        const baseDesc = document.getElementById('desc').value;
        const category = document.getElementById('category').value;
        const baseDate = new Date(document.getElementById('date').value);

        if (type === 'installments') {
            const total = parseFloat(document.getElementById('totalPrice').value);
            const count = parseInt(document.getElementById('numberOfPayments').value);
            const monthlyAmount = parseFloat(document.getElementById('amount').value);

            if (!total || !count || !monthlyAmount) return alert('× × ×œ××œ× ×¤×¨×˜×™ ×ª×©×œ×•××™×');
            if (!confirm(`×œ×™×¦×•×¨ ${count} ×—×™×•×‘×™× ×¢×ª×™×“×™×™×?`)) return;

            const updates = {};
            for (let i = 0; i < count; i++) {
                let nextDate = new Date(baseDate);
                nextDate.setMonth(baseDate.getMonth() + i);
                const newKey = expensesRef.push().key;
                updates[newKey] = {
                    type: 'installments',
                    desc: `${baseDesc} (${i + 1}/${count})`,
                    amount: monthlyAmount,
                    category: category,
                    date: nextDate.toISOString().split('T')[0],
                    fullAmount: total,
                    addedBy: currentUserProfile,
                    timestamp: Date.now() + i
                };
            }
            expensesRef.update(updates).then(() => { updateLastAction(); resetForm(); });
            return;
        }

        const newExpense = {
            type: type,
            desc: baseDesc,
            amount: parseFloat(document.getElementById('amount').value),
            category: category,
            date: document.getElementById('date').value,
            addedBy: currentUserProfile,
            timestamp: Date.now()
        };

        if (type === 'loan') {
            const months = parseInt(document.getElementById('monthsLeft').value);
            if(months) newExpense.monthsLeft = months;
        }

        expensesRef.push(newExpense).then(() => { updateLastAction(); resetForm(); });
    }

    function deleteExpense(firebaseId) {
        if(confirm('×œ××—×•×§?')) {
            expensesRef.child(firebaseId).remove().then(() => updateLastAction());
        }
    }

    function renderExpenses() {
        const tbody = document.getElementById('expensesTableBody');
        tbody.innerHTML = '';
        const filterCat = document.getElementById('filterCategory').value;
        const filterMonth = document.getElementById('filterMonth').value;

        let filtered = expenses.filter(exp => {
            return (filterCat === 'all' || exp.category === filterCat) &&
                   (!filterMonth || exp.date.startsWith(filterMonth));
        });

        filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

        if (filtered.length === 0) tbody.innerHTML = '<tr><td colspan="2" style="text-align:center; padding:20px; opacity:0.6">××™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×”</td></tr>';

        filtered.forEach(exp => {
            const tr = document.createElement('tr');
            let extraInfo = '';
            let typeBadge = '';
            
            if (exp.type === 'installments') {
                typeBadge = '<span class="badge badge-installments">×ª×©×œ×•××™×</span>';
                if (exp.fullAmount && !exp.desc.includes('(')) extraInfo = `<div style="font-size:0.8em; color:var(--primary-color);">×¡×”"×›: ${formatCurrency(exp.fullAmount)}</div>`;
            } else if (exp.type === 'loan' && exp.monthsLeft) {
                typeBadge = '<span class="badge badge-loan">×”×œ×•×•××”</span>';
                extraInfo = `<div style="font-size:0.8em; color:var(--danger-color);">â³ × ×•×ª×¨×• ${exp.monthsLeft} ×—×•×“×©×™×</div>`;
            }
            
            const addedBy = exp.addedBy ? `<span style="font-size:0.7em; color:#999; margin-right:5px">ğŸ‘¤ ${exp.addedBy}</span>` : '';

            tr.innerHTML = `
                <td>
                    <div style="font-weight:bold; font-size:1.05em;">${typeBadge} ${exp.desc}</div>
                    <div style="font-size:0.85em; opacity:0.7; margin-top:2px;">
                        ${formatDate(exp.date)} | <span style="color:var(--primary-color)">${exp.category}</span>
                        ${addedBy}
                    </div>
                    ${extraInfo}
                </td>
                <td style="text-align:left; vertical-align:top">
                    <div style="font-weight:bold; color:var(--success-color); font-size:1.1em;">${formatCurrency(exp.amount)}</div>
                    <button class="delete-btn" onclick="deleteExpense('${exp.firebaseId}')" style="margin-top:5px; font-size:0.75em">ğŸ—‘ï¸</button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        updateSummary(filtered);
        drawChart(filtered);
    }

    function toggleExtraFields() {
        const type = document.getElementById('expenseType').value;
        const extraContainer = document.getElementById('extraFields');
        const installmentsDiv = document.getElementById('installmentsContainer');
        const loanDiv = document.getElementById('loanContainer');
        const amountInput = document.getElementById('amount');
        const submitBtn = document.getElementById('submitBtn');

        extraContainer.style.display = 'none';
        installmentsDiv.style.display = 'none';
        loanDiv.style.display = 'none';
        amountInput.readOnly = false;
        amountInput.style.backgroundColor = 'var(--bg-color)';
        submitBtn.innerText = "×”×•×¡×£ ×”×•×¦××”";

        if (type === 'installments') {
            extraContainer.style.display = 'grid';
            installmentsDiv.style.display = 'block';
            amountInput.placeholder = "××—×•×©×‘ ××•×˜×•××˜×™×ª...";
            amountInput.readOnly = true;
            amountInput.style.backgroundColor = 'rgba(0,0,0,0.05)';
            submitBtn.innerText = "×¦×•×¨ ×¤×¨×™×¡×ª ×ª×©×œ×•××™×";
        } else if (type === 'loan') {
            extraContainer.style.display = 'grid';
            loanDiv.style.display = 'block';
            amountInput.placeholder = "×¡×›×•× ×”×—×–×¨ ×—×•×“×©×™";
        }
    }

    function calculateInstallment() {
        const total = parseFloat(document.getElementById('totalPrice').value);
        const count = parseInt(document.getElementById('numberOfPayments').value);
        if (total && count && count > 0) {
            const monthly = (total / count).toFixed(2);
            document.getElementById('amount').value = monthly;
            document.getElementById('installmentResult').innerText = `ğŸ’¡ ×—×™×©×•×‘: â‚ª${monthly} ×œ××©×š ${count} ×—×•×“×©×™×`;
        }
    }

    function resetForm() {
        document.getElementById('desc').value = '';
        document.getElementById('amount').value = '';
        document.getElementById('totalPrice').value = '';
        document.getElementById('numberOfPayments').value = '';
        document.getElementById('monthsLeft').value = '';
        document.getElementById('expenseType').value = 'regular';
        document.getElementById('installmentResult').innerText = '';
        toggleExtraFields();
    }

    function updateSummary(filteredData) {
        const total = filteredData.reduce((sum, item) => sum + item.amount, 0);
        const currentMonthStr = new Date().toISOString().slice(0, 7);
        const monthlyTotalAllCats = expenses
            .filter(e => e.date.startsWith(currentMonthStr))
            .reduce((sum, item) => sum + item.amount, 0);
        const displayTotal = document.getElementById('filterMonth').value ? total : monthlyTotalAllCats;
        document.getElementById('monthlyTotal').innerText = formatCurrency(displayTotal);
    }

    function drawChart(data) {
        const canvas = document.getElementById('expensesChart');
        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;
        ctx.clearRect(0, 0, width, height);
        if (data.length === 0) {
            ctx.font = "14px Arial"; ctx.fillStyle = "#888"; ctx.textAlign = "center";
            ctx.fillText("××™×Ÿ × ×ª×•× ×™×", width/2, height/2); return;
        }
        const categories = {};
        let total = 0;
        data.forEach(item => {
            categories[item.category] = (categories[item.category] || 0) + item.amount;
            total += item.amount;
        });
        let startAngle = 0;
        const colors = {'××–×•×Ÿ':'#FF6384', '×—×©××œ/××™×':'#36A2EB', '×ª×©×œ×•××™× ×§×‘×•×¢×™×': '#FF9F40', '×ª×—×‘×•×¨×”':'#FFCE56', '×‘×™×’×•×“':'#4BC0C0', '×‘×™×œ×•×™×™×':'#9966FF', '××—×¨':'#C9CBCF'};
        const centerX = width / 2;
        const centerY = height / 2;
        const radius = 80;
        for (let cat in categories) {
            const slice = (categories[cat] / total) * 2 * Math.PI;
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.arc(centerX, centerY, radius, startAngle, startAngle + slice);
            ctx.fillStyle = colors[cat] || '#888';
            ctx.fill();
            startAngle += slice;
        }
        ctx.beginPath(); ctx.arc(centerX, centerY, radius * 0.6, 0, 2*Math.PI); ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--card-bg'); ctx.fill();
    }

    function formatCurrency(num) { return new Intl.NumberFormat('he-IL', { style: 'currency', currency: 'ILS' }).format(num); }
    function formatDate(str) { const d = new Date(str); return `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear().toString().substr(-2)}`; }
    function toggleTheme() {
        const isDark = document.body.getAttribute('data-theme') === 'dark';
        if(isDark) { document.body.removeAttribute('data-theme'); localStorage.setItem('theme', 'light'); } 
        else { document.body.setAttribute('data-theme', 'dark'); localStorage.setItem('theme', 'dark'); }
        renderExpenses(); 
    }
    
    function migrateLocalToCloud() {
        const localData = JSON.parse(localStorage.getItem('home_expenses_v1') || "[]");
        if (!confirm('×œ×”×¢×œ×•×ª × ×ª×•× ×™× ×™×©× ×™× ×œ×—×©×‘×•×Ÿ ×–×”?')) return;
        localData.forEach(item => {
            const { id, ...cleanItem } = item;
            if(!cleanItem.timestamp) cleanItem.timestamp = Date.now();
            cleanItem.type = 'regular';
            cleanItem.addedBy = currentUserProfile;
            expensesRef.push(cleanItem);
        });
        localStorage.removeItem('home_expenses_v1');
        document.getElementById('syncBtn').style.display = 'none';
        updateLastAction();
    }
</script>
</body>
</html>