<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×× ×”×œ ×”×•×¦××•×ª ××©×¤×—×ª×™ â˜ï¸</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <style>
        :root {
            --primary-color: #4f46e5;
            --secondary-color: #818cf8;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-color: #1f2937;
            --border-color: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --bg-color: #111827;
            --card-bg: #1f2937;
            --text-color: #f9fafb;
            --border-color: #374151;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-color); direction: rtl; text-align: right; padding-bottom: 40px; transition: background 0.3s; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        
        /* Components */
        .card { background-color: var(--card-bg); border-radius: 12px; padding: 20px; box-shadow: var(--shadow); margin-bottom: 20px; border: 1px solid var(--border-color); }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal { background: var(--card-bg); padding: 30px; border-radius: 16px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); border: 1px solid var(--border-color); position: relative; }
        .modal input { width: 100%; margin-bottom: 15px; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-color); color: var(--text-color); font-size:1rem; }
        
        button.add-btn { background-color: var(--primary-color); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; width: 100%; font-weight: bold; margin-top: 10px; font-size:1rem; }
        button.add-btn:hover { opacity: 0.9; }

        /* Auth Tabs */
        .auth-tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); }
        .auth-tab { flex: 1; padding: 10px; cursor: pointer; color: var(--text-color); opacity: 0.6; }
        .auth-tab.active { border-bottom: 2px solid var(--primary-color); opacity: 1; font-weight: bold; color: var(--primary-color); }
        .auth-error { color: var(--danger-color); margin-top: 10px; font-size: 0.9rem; display: none; background: rgba(239, 68, 68, 0.1); padding: 10px; border-radius: 6px; text-align: right; }

        /* Header */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .icon-btn { background: none; border: 1px solid var(--border-color); padding: 8px; border-radius: 8px; cursor: pointer; color: var(--text-color); font-size: 1.2rem; }
        .status-dot { height: 10px; width: 10px; background-color: #ccc; border-radius: 50%; display: inline-block; }
        .status-online { background-color: var(--success-color); box-shadow: 0 0 8px var(--success-color); }

        /* Form & List */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; align-items: end; }
        input, select { padding: 10px; width: 100%; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-color); font-size: 1rem; }
        .expense-list { width: 100%; border-collapse: collapse; }
        .expense-list td { padding: 12px; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        
        .extra-fields { background-color: rgba(59, 130, 246, 0.05); padding: 15px; border-radius: 8px; margin-top: 10px; display: none; grid-column: 1 / -1; border: 1px dashed var(--primary-color); }
        
        .methods-list { text-align: right; max-height: 200px; overflow-y: auto; margin-bottom: 15px; }
        .method-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid var(--border-color); align-items: center; }
        .delete-btn-small { background: #fee2e2; color: var(--danger-color); border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
        
        .profile-btn { background: var(--bg-color); border: 1px solid var(--border-color); padding: 12px; margin: 8px 0; width: 100%; border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; color: var(--text-color); }
        .close-modal { position: absolute; top: 15px; left: 15px; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-color); }

        #syncBtn { display: none; background: var(--primary-color); color: white; border: none; padding: 15px; width: 100%; border-radius: 8px; margin-bottom: 20px; cursor: pointer; font-weight: bold; }
        .loader { text-align: center; padding: 20px; display: none; opacity: 0.7; }
    </style>
</head>
<body>

<div id="authOverlay" class="overlay">
    <div class="modal">
        <h2>ğŸ  ×›× ×™×¡×” ×œ×‘×™×ª</h2>
        <div class="auth-tabs">
            <div class="auth-tab active" onclick="switchAuthTab('login')" id="tabLogin">×”×ª×—×‘×¨×•×ª</div>
            <div class="auth-tab" onclick="switchAuthTab('register')" id="tabRegister">×™×¦×™×¨×ª ×‘×™×ª ×—×“×©</div>
        </div>
        
        <form onsubmit="handleAuth(event)">
            <input type="email" id="authEmail" placeholder="××™××™×™×œ" required dir="ltr">
            <input type="password" id="authPass" placeholder="×¡×™×¡××” (6+ ×ª×•×•×™×)" required dir="ltr" minlength="6">
            
            <button type="submit" class="add-btn" id="authSubmitBtn">×”×›× ×¡ ×œ×‘×™×ª</button>
            <div id="authError" class="auth-error"></div>
        </form>

        <a onclick="handleForgotPassword()" style="display:block; margin-top:15px; color:var(--primary-color); text-decoration:underline; cursor:pointer; font-size:0.9rem" id="forgotPassLink">×©×›×—×ª×™ ×¡×™×¡××”?</a>
    </div>
</div>

<div id="profileOverlay" class="overlay" style="display:none">
    <div class="modal">
        <h2>ğŸ‘‹ ××™ ×–×”?</h2>
        <div id="profilesList" style="margin-bottom:20px; max-height: 200px; overflow-y: auto;"></div>
        <div style="border-top:1px solid var(--border-color); padding-top:15px">
            <input type="text" id="newProfileName" placeholder="×©× ×¤×¨×•×¤×™×œ ×—×“×©" style="margin-bottom:10px">
            <button onclick="selectProfile(document.getElementById('newProfileName').value)" class="add-btn" style="background-color: var(--success-color)">×¦×•×¨ ×•×›× ×¡</button>
        </div>
        <button onclick="logout()" style="background:none; border:none; color:var(--danger-color); margin-top:15px; cursor:pointer">×™×¦×™××”</button>
    </div>
</div>

<div id="settingsOverlay" class="overlay" style="display:none">
    <div class="modal">
        <button class="close-modal" onclick="document.getElementById('settingsOverlay').style.display='none'">Ã—</button>
        <h2>ğŸ’³ ×××¦×¢×™ ×ª×©×œ×•×</h2>
        <div class="methods-list" id="methodsSettingsList"></div>
        <div style="display:flex; gap:10px">
            <input type="text" id="newMethodName" placeholder="×©× ×”×××¦×¢×™ (×œ××©×œ: ×•×™×–×”)" style="margin-bottom:0">
            <button onclick="addNewPaymentMethod()" class="add-btn" style="margin-top:0; width:auto; white-space:nowrap">×”×•×¡×£</button>
        </div>
    </div>
</div>

<div class="container">
    <header>
        <div>
            <h1 style="color:var(--primary-color); margin:0; display:flex; align-items:center; gap:10px">
                <span id="connectionStatus" class="status-dot"></span> ×”×•×¦××•×ª ×”×‘×™×ª
            </h1>
            <small style="color:#888" id="currentUserDisplay"></small>
        </div>
        <div style="display:flex; gap:5px">
            <button onclick="document.getElementById('settingsOverlay').style.display='flex'" class="icon-btn" title="×××¦×¢×™ ×ª×©×œ×•×">âš™ï¸</button>
            <button onclick="toggleTheme()" class="icon-btn" title="×¢×¨×›×ª × ×•×©×">ğŸŒ“</button>
            <button onclick="logout()" class="icon-btn" style="color:var(--danger-color); border-color:var(--danger-color)" title="×™×¦×™××”">âœ</button>
        </div>
    </header>

    <div style="background:var(--card-bg); padding:10px; border-radius:8px; margin-bottom:20px; border:1px solid var(--border-color); font-size:0.9rem; color:#666; display:flex; justify-content:space-between;">
        <span>ğŸ“… ×¢×•×“×›×Ÿ: <span id="lastUpdateText">--</span></span>
        <span id="lastUpdateUser" style="color:var(--primary-color); font-weight:bold"></span>
    </div>

    <button id="syncBtn" onclick="migrateLocalToCloud()">âš ï¸ ×”×¢×œ×” × ×ª×•× ×™× ×™×©× ×™× ×œ×¢× ×Ÿ</button>
    <div id="loader" class="loader">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>

    <div class="dashboard card">
        <div style="text-align: center;">
            <h2>×¡×”"×› ×—×•×“×©×™</h2>
            <div class="total-amount" id="monthlyTotal">â‚ª0.00</div>
        </div>
        <div class="chart-container">
            <canvas id="expensesChart" width="200" height="200"></canvas>
        </div>
    </div>

    <div class="card">
        <h3>â• ×”×•×¡×¤×”</h3>
        <form id="expenseForm" onsubmit="addExpense(event)">
            <div class="form-grid">
                <select id="expenseType" onchange="toggleExtraFields()">
                    <option value="regular">×¨×’×™×œ×”</option>
                    <option value="installments">ğŸ’³ ×ª×©×œ×•××™×</option>
                    <option value="loan">ğŸ¦ ×”×œ×•×•××”</option>
                </select>
                <select id="category">
                    <option value="××–×•×Ÿ">ğŸ• ××–×•×Ÿ</option>
                    <option value="×—×©××œ/××™×">ğŸ’¡ ×—×©××œ/××™×</option>
                    <option value="×ª×©×œ×•××™× ×§×‘×•×¢×™×">ğŸ¦ ×§×‘×•×¢×™×</option>
                    <option value="×ª×—×‘×•×¨×”">ğŸš— ×ª×—×‘×•×¨×”</option>
                    <option value="×‘×™×’×•×“">ğŸ‘• ×‘×™×’×•×“</option>
                    <option value="×‘×™×œ×•×™×™×">ğŸ‰ ×‘×™×œ×•×™×™×</option>
                    <option value="××—×¨">ğŸ“¦ ××—×¨</option>
                </select>
                <select id="paymentMethodSelect" style="grid-column: span 2;">
                     <option value="">-- ×××¦×¢×™ ×ª×©×œ×•× (×¨×©×•×ª) --</option>
                </select>
                <input type="text" id="desc" placeholder="×ª×™××•×¨" required>
                <input type="number" id="amount" placeholder="×¡×›×•×" step="0.01" required>
                <input type="date" id="date" required>
            </div>

            <div id="extraFields" class="extra-fields form-grid">
                <div id="installmentsContainer" style="display:none; width:100%; grid-column: 1 / -1;">
                    <div class="form-grid">
                        <input type="number" id="totalPrice" placeholder="×¡×”×´×› ××œ×" oninput="calculateInstallment()">
                        <input type="number" id="numberOfPayments" placeholder="××¡' ×ª×©×œ×•××™×" oninput="calculateInstallment()">
                    </div>
                    <div id="installmentResult" style="margin-top:5px; color:var(--primary-color); font-weight:bold"></div>
                </div>
                <div id="loanContainer" style="display:none; width:100%">
                    <input type="number" id="monthsLeft" placeholder="×™×ª×¨×ª ×—×•×“×©×™×">
                </div>
            </div>
            <button type="submit" class="add-btn" id="submitBtn">×”×•×¡×£</button>
        </form>
    </div>

    <div class="card">
        <div class="filters">
            <select id="filterCategory" onchange="renderExpenses()">
                <option value="all">×”×›×œ</option>
                <option value="××–×•×Ÿ">××–×•×Ÿ</option>
                <option value="×—×©××œ/××™×">×—×©××œ/××™×</option>
                <option value="×ª×©×œ×•××™× ×§×‘×•×¢×™×">×§×‘×•×¢×™×</option>
                <option value="×ª×—×‘×•×¨×”">×ª×—×‘×•×¨×”</option>
                <option value="×‘×™×’×•×“">×‘×™×’×•×“</option>
                <option value="×‘×™×œ×•×™×™×">×‘×™×œ×•×™×™×</option>
                <option value="××—×¨">××—×¨</option>
            </select>
            <input type="month" id="filterMonth" onchange="renderExpenses()">
        </div>
        <table class="expense-list">
            <tbody id="expensesTableBody"></tbody>
        </table>
    </div>
</div>

<script>
    // -----------------------------------------------------------------
    //  ğŸ‘‡ ××™×–×•×¨ ×”×”×’×“×¨×•×ª - ×¢×œ×™×š ×œ×¢×¨×•×š ××ª ×©×•×¨×ª ×”-apiKey ×‘×œ×‘×“! ğŸ‘‡
    // -----------------------------------------------------------------
    const firebaseConfig = {
      apiKey: "[REDACTED_GCP_API_KEY_1]", 
      authDomain: "homeexpenses-e2bb7.firebaseapp.com",
      databaseURL: "https://homeexpenses-e2bb7-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "homeexpenses-e2bb7",
      storageBucket: "homeexpenses-e2bb7.firebasestorage.app",
      messagingSenderId: "322915198222",
      appId: "1:322915198222:web:fcc826384329c9bfb9a35f"
    };
    // -----------------------------------------------------------------

    // ×‘×“×™×§×” ××”×™×¨×” ×©×”××©×ª××© ×¢×“×›×Ÿ ××ª ×”××¤×ª×—
    if (firebaseConfig.apiKey.includes("×›××Ÿ_×ª×“×‘×™×§")) {
        alert("×¢×¦×•×¨! ğŸ›‘\n×¢×“×™×™×Ÿ ×œ× ×”×“×‘×§×ª ××ª ×”-API Key ×©×œ×š ×‘×§×•×‘×¥.\n×—×¤×© ××ª ×©×•×¨×” 287 ×‘×§×•×“, ×”×“×‘×§ ××ª ×”××¤×ª×— ×©××ª×—×™×œ ×‘-AIza, ×©××•×¨ ×•×¨×¢× ×Ÿ.");
    }

    let app, db, auth, expensesRef, metaRef, usersRef, methodsRef;
    let expenses = [], paymentMethods = {};
    let currentUserProfile = null;
    let isRegisterMode = false;

    try {
        app = firebase.initializeApp(firebaseConfig);
        db = firebase.database();
        auth = firebase.auth();
    } catch (e) { console.error("Firebase init error:", e); }

    // --- ×˜×™×¤×•×œ ×‘××©×ª××©×™× ---
    function switchAuthTab(mode) {
        isRegisterMode = mode === 'register';
        document.getElementById('tabLogin').className = isRegisterMode ? 'auth-tab' : 'auth-tab active';
        document.getElementById('tabRegister').className = isRegisterMode ? 'auth-tab active' : 'auth-tab';
        document.getElementById('authSubmitBtn').innerText = isRegisterMode ? '×¦×•×¨ ×‘×™×ª ×—×“×©' : '×”×›× ×¡ ×œ×‘×™×ª';
        document.getElementById('authError').style.display = 'none';
        document.getElementById('forgotPassLink').style.display = isRegisterMode ? 'none' : 'block';
    }

    function handleAuth(e) {
        e.preventDefault();
        const email = document.getElementById('authEmail').value;
        const pass = document.getElementById('authPass').value;
        const errorDiv = document.getElementById('authError');
        errorDiv.style.display = 'none';

        if(!email || !pass) return;

        const action = isRegisterMode ? auth.createUserWithEmailAndPassword(email, pass) : auth.signInWithEmailAndPassword(email, pass);
        
        action.then(() => {
            console.log("Auth Success");
        }).catch(err => {
            errorDiv.style.display = 'block';
            console.error("Auth Error Full:", err);
            
            let msg = '×©×’×™××”: ' + err.message;
            if (err.code === 'auth/wrong-password') msg = '×”×¡×™×¡××” ×©×’×•×™×”.';
            if (err.code === 'auth/user-not-found') msg = '××©×ª××© ×œ× ×§×™×™×. ×¢×‘×•×¨ ×œ"×™×¦×™×¨×ª ×‘×™×ª ×—×“×©".';
            if (err.code === 'auth/email-already-in-use') msg = '×”××™×™×œ ×”×–×” ×›×‘×¨ ×¨×©×•× ×‘××¢×¨×›×ª.';
            if (err.code === 'auth/weak-password') msg = '×¡×™×¡××” ×—×œ×©×” (×œ×¤×—×•×ª 6 ×ª×•×•×™×).';
            if (err.code === 'auth/invalid-email') msg = '×›×ª×•×‘×ª ×”××™×™×œ ×œ× ×ª×§×™× ×”.';
            if (err.code === 'auth/internal-error') msg = '×©×’×™××ª ×—×™×‘×•×¨ (Internal Error).\n×•×“× ×©×”×“×‘×§×ª ××ª ×”-API Key ×”× ×›×•×Ÿ ×‘×§×•×“,\n×•×©×”×¤×¢×œ×ª Email/Password ×‘-Firebase Console.';
            
            errorDiv.innerText = msg;
        });
    }

    function handleForgotPassword() {
        const email = document.getElementById('authEmail').value;
        if (!email) {
            alert("×”×–×Ÿ ×›×ª×•×‘×ª ××™×™×œ ×•×œ×—×¥ ×©×•×‘ ×¢×œ ×”×§×™×©×•×¨");
            return;
        }
        auth.sendPasswordResetEmail(email)
            .then(() => alert("× ×©×œ×— ×§×™×©×•×¨ ×œ××™×¤×•×¡ ×¡×™×¡××” ×œ: " + email))
            .catch(error => alert("×©×’×™××”: " + error.message));
    }

    if(auth) {
        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('authOverlay').style.display = 'none';
                const householdPath = `households/${user.uid}`;
                expensesRef = db.ref(`${householdPath}/expenses`);
                usersRef = db.ref(`${householdPath}/users`);
                methodsRef = db.ref(`${householdPath}/paymentMethods`);
                metaRef = db.ref(`${householdPath}/meta/lastUpdate`);

                const savedProfile = localStorage.getItem(`profile_${user.uid}`);
                if (savedProfile) {
                    selectProfile(savedProfile, false);
                } else {
                    document.getElementById('profileOverlay').style.display = 'flex';
                    loadUsersList();
                }
            } else {
                document.getElementById('authOverlay').style.display = 'flex';
                document.getElementById('profileOverlay').style.display = 'none';
                document.getElementById('settingsOverlay').style.display = 'none';
                expenses = [];
                renderExpenses();
            }
        });
    }

    function logout() {
        auth.signOut().then(() => {
            currentUserProfile = null;
            location.reload(); 
        });
    }

    // --- ×¤×¨×•×¤×™×œ×™× ---
    function loadUsersList() {
        usersRef.once('value', snap => {
            const listDiv = document.getElementById('profilesList');
            listDiv.innerHTML = '';
            const users = snap.val();
            if (users) {
                Object.keys(users).forEach(name => {
                    const btn = document.createElement('div');
                    btn.className = 'profile-btn';
                    btn.innerHTML = `<span>ğŸ‘¤ ${name}</span> <span>âœ</span>`;
                    btn.onclick = () => selectProfile(name, true);
                    listDiv.appendChild(btn);
                });
            } else {
                listDiv.innerHTML = '<p style="color:#888">××™×Ÿ ×¤×¨×•×¤×™×œ×™×. ×¦×•×¨ ××—×“ ×—×“×©.</p>';
            }
        });
    }

    function selectProfile(name, updateDB) {
        if (!name || !name.trim()) return;
        name = name.trim();
        currentUserProfile = name;
        localStorage.setItem(`profile_${auth.currentUser.uid}`, name);
        if(updateDB) usersRef.child(name).set(true);
        document.getElementById('profileOverlay').style.display = 'none';
        document.getElementById('currentUserDisplay').innerText = `×©×œ×•×, ${name}`;
        listenToData();
    }

    // --- ×××¦×¢×™ ×ª×©×œ×•× ---
    function listenToPaymentMethods() {
        methodsRef.on('value', snap => {
            paymentMethods = snap.val() || {};
            renderPaymentMethodsSettings();
            renderPaymentMethodOptions();
        });
    }
    function addNewPaymentMethod() {
        const name = document.getElementById('newMethodName').value;
        if(name.trim()) { methodsRef.push(name.trim()); document.getElementById('newMethodName').value = ''; }
    }
    function deletePaymentMethod(key) {
        if(confirm('×œ××—×•×§?')) methodsRef.child(key).remove();
    }
    function renderPaymentMethodsSettings() {
        const list = document.getElementById('methodsSettingsList');
        list.innerHTML = '';
        Object.keys(paymentMethods).forEach(key => {
            const div = document.createElement('div');
            div.className = 'method-item';
            div.innerHTML = `<span>${paymentMethods[key]}</span> <button class="delete-btn-small" onclick="deletePaymentMethod('${key}')">××—×§</button>`;
            list.appendChild(div);
        });
    }
    function renderPaymentMethodOptions() {
        const select = document.getElementById('paymentMethodSelect');
        const currentVal = select.value;
        select.innerHTML = '<option value="">-- ×××¦×¢×™ ×ª×©×œ×•× (×¨×©×•×ª) --</option>';
        Object.keys(paymentMethods).forEach(key => {
            const opt = document.createElement('option');
            opt.value = paymentMethods[key];
            opt.innerText = paymentMethods[key];
            select.appendChild(opt);
        });
        select.value = currentVal;
    }

    // --- × ×ª×•× ×™× ×¨××©×™×™× ---
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('date').valueAsDate = new Date();
        const today = new Date();
        document.getElementById('filterMonth').value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
        if(localStorage.getItem('theme') === 'dark') document.body.setAttribute('data-theme', 'dark');
    });

    function listenToData() {
        document.getElementById('loader').style.display = 'block';
        db.ref('.info/connected').on('value', snap => {
            document.getElementById('connectionStatus').className = snap.val() ? 'status-dot status-online' : 'status-dot';
        });
        metaRef.on('value', snap => {
            if (snap.val()) {
                document.getElementById('lastUpdateText').innerText = snap.val().time;
                document.getElementById('lastUpdateUser').innerText = snap.val().user;
            }
        });
        listenToPaymentMethods();
        expensesRef.on('value', snapshot => {
            document.getElementById('loader').style.display = 'none';
            expenses = [];
            const data = snapshot.val();
            if (data) Object.keys(data).forEach(key => expenses.push({ ...data[key], firebaseId: key }));
            renderExpenses();
            if (localStorage.getItem('home_expenses_v1')) document.getElementById('syncBtn').style.display = 'block';
        });
    }

    function updateLastAction() {
        const now = new Date();
        metaRef.set({ user: currentUserProfile, time: `${now.getDate()}/${now.getMonth()+1} ${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}` });
    }

    function addExpense(e) {
        e.preventDefault();
        const type = document.getElementById('expenseType').value;
        const baseDesc = document.getElementById('desc').value;
        const category = document.getElementById('category').value;
        const method = document.getElementById('paymentMethodSelect').value;
        const dateVal = document.getElementById('date').value;
        const amount = parseFloat(document.getElementById('amount').value);

        if (type === 'installments') {
            const count = parseInt(document.getElementById('numberOfPayments').value);
            const total = parseFloat(document.getElementById('totalPrice').value);
            if (!total || !count) return alert('×—×¡×¨×™× ×¤×¨×˜×™ ×ª×©×œ×•××™×');
            
            const updates = {};
            const baseDateObj = new Date(dateVal);
            for (let i = 0; i < count; i++) {
                let nextDate = new Date(baseDateObj);
                nextDate.setMonth(baseDateObj.getMonth() + i);
                const newKey = expensesRef.push().key;
                updates[newKey] = {
                    type, desc: `${baseDesc} (${i + 1}/${count})`, amount, category, paymentMethod: method,
                    date: nextDate.toISOString().split('T')[0], fullAmount: total, addedBy: currentUserProfile, timestamp: Date.now() + i
                };
            }
            expensesRef.update(updates).then(() => { updateLastAction(); resetForm(); });
        } else {
            const newExpense = {
                type, desc: baseDesc, amount, category, paymentMethod: method, date: dateVal,
                addedBy: currentUserProfile, timestamp: Date.now()
            };
            if (type === 'loan') newExpense.monthsLeft = parseInt(document.getElementById('monthsLeft').value) || 0;
            expensesRef.push(newExpense).then(() => { updateLastAction(); resetForm(); });
        }
    }

    function deleteExpense(key) { if(confirm('×œ××—×•×§?')) expensesRef.child(key).remove().then(updateLastAction); }

    function renderExpenses() {
        const tbody = document.getElementById('expensesTableBody');
        tbody.innerHTML = '';
        const fCat = document.getElementById('filterCategory').value;
        const fMonth = document.getElementById('filterMonth').value;

        let filtered = expenses.filter(exp => 
            (fCat === 'all' || exp.category === fCat) && (!fMonth || exp.date.startsWith(fMonth))
        );
        filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

        if (filtered.length === 0) tbody.innerHTML = '<tr><td colspan="2" style="text-align:center; padding:20px; opacity:0.6">××™×Ÿ × ×ª×•× ×™×</td></tr>';

        filtered.forEach(exp => {
            const tr = document.createElement('tr');
            const payTag = exp.paymentMethod ? `<div style="font-size:0.8em; color:#666">ğŸ’³ ${exp.paymentMethod}</div>` : '';
            const userTag = exp.addedBy ? `<span style="font-size:0.75em; color:#999; margin-left:5px">ğŸ‘¤ ${exp.addedBy}</span>` : '';
            let extra = '';
            if (exp.type === 'installments' && exp.fullAmount && !exp.desc.includes('(')) extra = `<div style="font-size:0.8em; color:var(--primary-color)">×¡×”"×›: â‚ª${exp.fullAmount}</div>`;
            if (exp.type === 'loan') extra = `<div style="font-size:0.8em; color:var(--danger-color)">× ×•×ª×¨×•: ${exp.monthsLeft}</div>`;

            tr.innerHTML = `
                <td>
                    <div style="font-weight:bold">${exp.desc}</div>
                    <div style="font-size:0.85em; opacity:0.8; margin:2px 0">${formatDate(exp.date)} | ${exp.category}</div>
                    ${payTag} ${extra} ${userTag}
                </td>
                <td style="vertical-align:top; text-align:left">
                    <div style="font-weight:bold; color:var(--success-color); font-size:1.1em">â‚ª${exp.amount.toLocaleString()}</div>
                    <button style="margin-top:5px; background:none; border:1px solid #ddd; padding:4px 8px; border-radius:4px; cursor:pointer" onclick="deleteExpense('${exp.firebaseId}')">ğŸ—‘ï¸</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
        updateSummary(filtered);
        drawChart(filtered);
    }

    function toggleExtraFields() {
        const type = document.getElementById('expenseType').value;
        document.getElementById('extraFields').style.display = (type === 'regular') ? 'none' : 'grid';
        document.getElementById('installmentsContainer').style.display = (type === 'installments') ? 'block' : 'none';
        document.getElementById('loanContainer').style.display = (type === 'loan') ? 'block' : 'none';
        
        const amt = document.getElementById('amount');
        const btn = document.getElementById('submitBtn');
        if(type === 'installments') {
            amt.readOnly = true; amt.placeholder = "××—×•×©×‘ ××•×˜×•××˜×™×ª"; amt.style.background = "#eee";
            btn.innerText = "×¦×•×¨ ×¤×¨×™×¡×ª ×ª×©×œ×•××™×";
        } else {
            amt.readOnly = false; amt.placeholder = "×¡×›×•×"; amt.style.background = "var(--bg-color)";
            btn.innerText = "×”×•×¡×£";
        }
    }

    function calculateInstallment() {
        const t = parseFloat(document.getElementById('totalPrice').value);
        const n = parseInt(document.getElementById('numberOfPayments').value);
        if(t && n) {
            const res = (t/n).toFixed(2);
            document.getElementById('amount').value = res;
            document.getElementById('installmentResult').innerText = `â‚ª${res} ×œ×—×•×“×©`;
        }
    }

    function resetForm() {
        document.getElementById('expenseForm').reset();
        document.getElementById('expenseType').value = 'regular';
        toggleExtraFields();
    }

    function updateSummary(filteredData) {
        const total = filteredData.reduce((sum, item) => sum + item.amount, 0);
        const fMonth = document.getElementById('filterMonth').value;
        if (!fMonth) {
             const nowStr = new Date().toISOString().slice(0, 7);
             const monthSum = expenses.filter(e => e.date.startsWith(nowStr)).reduce((s, i) => s + i.amount, 0);
             document.getElementById('monthlyTotal').innerText = 'â‚ª' + monthSum.toLocaleString();
        } else {
             document.getElementById('monthlyTotal').innerText = 'â‚ª' + total.toLocaleString();
        }
    }

    function drawChart(data) {
        const ctx = document.getElementById('expensesChart').getContext('2d');
        if(data.length === 0) { ctx.clearRect(0,0,200,200); return; }
        const cats = {}; let tot = 0;
        data.forEach(i => { cats[i.category] = (cats[i.category]||0) + i.amount; tot += i.amount; });
        
        let start = 0;
        const colors = {'××–×•×Ÿ':'#FF6384', '×—×©××œ/××™×':'#36A2EB', '×ª×©×œ×•××™× ×§×‘×•×¢×™×': '#FF9F40', '×ª×—×‘×•×¨×”':'#FFCE56', '×‘×™×’×•×“':'#4BC0C0', '×‘×™×œ×•×™×™×':'#9966FF', '××—×¨':'#C9CBCF'};
        
        ctx.clearRect(0,0,200,200);
        for(let c in cats) {
            const slice = (cats[c]/tot)*2*Math.PI;
            ctx.beginPath(); ctx.moveTo(100,100); ctx.arc(100,100,80,start,start+slice);
            ctx.fillStyle = colors[c]||'#888'; ctx.fill(); start += slice;
        }
        ctx.beginPath(); ctx.arc(100,100,50,0,2*Math.PI); ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--card-bg'); ctx.fill();
    }

    function formatDate(s) { const d=new Date(s); return `${d.getDate()}/${d.getMonth()+1}`; }
    function toggleTheme() {
        const dark = document.body.getAttribute('data-theme') === 'dark';
        dark ? document.body.removeAttribute('data-theme') : document.body.setAttribute('data-theme', 'dark');
        localStorage.setItem('theme', dark ? 'light' : 'dark');
        renderExpenses();
    }
    function migrateLocalToCloud() {
        const ld = JSON.parse(localStorage.getItem('home_expenses_v1')||"[]");
        if(confirm('×œ×”×¢×œ×•×ª?')) {
            ld.forEach(i => { delete i.id; i.addedBy=currentUserProfile; i.type='regular'; expensesRef.push(i); });
            localStorage.removeItem('home_expenses_v1'); location.reload();
        }
    }
</script>
</body>
</html>
